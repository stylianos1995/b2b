# MVP Integration Test Plan

## Structured scenarios for MVP capabilities

Aligned with MVP Feature Map (11), API Skeleton (12), Event Flow (10), Permission Model (08), and Service Boundaries (09). MVP flows only; no UI tests.

---

## 1. Scope and conventions

- **Base URL:** `/v1`. All requests use `Content-Type: application/json` unless noted.
- **Auth:** `Authorization: Bearer <access_token>` for protected endpoints. Token from `POST /auth/login` or `POST /auth/register` (if it returns token).
- **Idempotency:** Send `Idempotency-Key: <uuid>` on POST /buyer/orders, POST /invoices/:id/payments, POST /admin/payouts.
- **Success:** HTTP 2xx and response body as per API skeleton. **Failure:** 4xx/5xx and error body `{ "code", "message", "details" }`.
- **Events:** Verify emission (e.g. via test double or event log) where stated.

---

## 2. Auth and identity

| Scenario                                    | Capability            | Service(s) | Role(s)       | Steps                                                           | Expected Outcome                                                                       | Event(s)               |
| ------------------------------------------- | --------------------- | ---------- | ------------- | --------------------------------------------------------------- | -------------------------------------------------------------------------------------- | ---------------------- |
| Register new user (success)                 | Register (sign up)    | Identity   | —             | POST /auth/register with email, password, first_name, last_name | 201; body has user_id, email, created_at; user and session/token as per implementation | UserRegistered (async) |
| Register duplicate email (failure)          | Register (sign up)    | Identity   | —             | POST /auth/register with same email as existing user            | 409 or 422; user not created                                                           | —                      |
| Register invalid payload (failure)          | Register (sign up)    | Identity   | —             | POST /auth/register with missing email or password              | 400; validation error                                                                  | —                      |
| Login with valid credentials (success)      | Login                 | Identity   | —             | POST /auth/login with email, password                           | 200; access_token, refresh_token, expires_in                                           | —                      |
| Login with invalid credentials (failure)    | Login                 | Identity   | —             | POST /auth/login with wrong password                            | 401                                                                                    | —                      |
| Get current user with valid token (success) | Get current user (me) | Identity   | Authenticated | GET /auth/me with Bearer token                                  | 200; user_id, email, first_name, last_name, memberships[]                              | —                      |
| Get current user without token (failure)    | Get current user (me) | Identity   | —             | GET /auth/me without Authorization                              | 401                                                                                    | —                      |
| Refresh token (success)                     | Refresh token         | Identity   | Authenticated | POST /auth/refresh with refresh_token                           | 200; new access_token, expires_in                                                      | —                      |
| Logout (success)                            | Logout                | Identity   | Authenticated | POST /auth/logout with Bearer token                             | 200 or 204; token invalidated (if stored)                                              | —                      |
| Forgot password (success)                   | Forgot password       | Identity   | —             | POST /auth/forgot-password with email                           | 200 or 202; no sensitive data in response                                              | —                      |
| Reset password with valid token (success)   | Reset password        | Identity   | —             | POST /auth/reset-password with token, new_password              | 200; password updated                                                                  | —                      |

---

## 3. Business onboarding

| Scenario                                   | Capability              | Service(s) | Role(s)                                       | Steps                                                                                                             | Expected Outcome                                                                          | Event(s)                |
| ------------------------------------------ | ----------------------- | ---------- | --------------------------------------------- | ----------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------- | ----------------------- |
| Create business (success)                  | Create business         | Business   | User (becomes BusinessOwner)                  | POST /businesses with legal_name, trading_name, business_type, address fields; use token of newly registered user | 201; business_id, created_at; business_users row created with role business_owner         | BusinessCreated (async) |
| Create business unauthenticated (failure)  | Create business         | Business   | —                                             | POST /businesses without token                                                                                    | 401                                                                                       | —                       |
| Get business profile (success)             | Get business profile    | Business   | BusinessOwner, BusinessManager, BusinessStaff | GET /businesses/:id with token of user linked to that business                                                    | 200; business_id, legal_name, trading_name, business_type, status, default_currency, etc. | —                       |
| Get business profile wrong scope (failure) | Get business profile    | Business   | —                                             | GET /businesses/:id with token of user not linked to that business                                                | 403 or 404                                                                                | —                       |
| Update business profile (success)          | Update business profile | Business   | BusinessOwner, BusinessManager                | PATCH /businesses/:id with legal_name or trading_name; token with role owner or manager                           | 200; business_id, updated_at                                                              | —                       |
| Update business as Staff (failure)         | Update business profile | Business   | BusinessStaff                                 | PATCH /businesses/:id with token of BusinessStaff                                                                 | 403                                                                                       | —                       |
| Add delivery address (success)             | Add delivery address    | Business   | BusinessOwner, BusinessManager, BusinessStaff | POST /businesses/:id/locations with address_line_1, city, postal_code, country                                    | 201; location_id, created_at; location.owner_type=business, owner_id=business_id          | —                       |
| Get delivery addresses (success)           | Get delivery addresses  | Business   | BusinessOwner, BusinessManager, BusinessStaff | GET /businesses/:id/locations                                                                                     | 200; items[] with location_id, address_line_1, city, postal_code, is_default              | —                       |

---

## 4. Provider registration and catalog

| Scenario                                   | Capability              | Service(s) | Role(s)                                       | Steps                                                                                  | Expected Outcome                                                                           | Event(s)                                    |
| ------------------------------------------ | ----------------------- | ---------- | --------------------------------------------- | -------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------ | ------------------------------------------- |
| Create provider (success)                  | Create provider         | Provider   | User (becomes ProviderOwner)                  | POST /providers with legal_name, trading_name, provider_type, address; new user token  | 201; provider_id, status (e.g. active), created_at; provider_users row with provider_owner | ProviderVerified (async when status=active) |
| Get provider profile (success)             | Get provider profile    | Provider   | ProviderOwner, ProviderManager, ProviderStaff | GET /providers/:id with token linked to that provider                                  | 200; provider_id, legal_name, trading_name, provider_type, status                          | —                                           |
| Get provider profile wrong scope (failure) | Get provider profile    | Provider   | —                                             | GET /providers/:id with buyer token                                                    | 403 or 404                                                                                 | —                                           |
| Update provider profile (success)          | Update provider profile | Provider   | ProviderOwner, ProviderManager                | PATCH /providers/:id with description or default_currency                              | 200; provider_id, updated_at                                                               | —                                           |
| Add product (success)                      | Add product             | Provider   | ProviderOwner, ProviderManager, ProviderStaff | POST /providers/:id/products with sku, name, category, unit, price, currency, tax_rate | 201; product_id, created_at                                                                | ProductCreated (async)                      |
| Add product wrong provider (failure)       | Add product             | Provider   | —                                             | POST /providers/:id/products with token linked to different provider                   | 403                                                                                        | —                                           |
| Get products catalog (success)             | Get products (catalog)  | Provider   | ProviderOwner, ProviderManager, ProviderStaff | GET /providers/:id/products                                                            | 200; items[] with product_id, sku, name, price, is_active; next_cursor if paginated        | —                                           |
| Update product (success)                   | Update product          | Provider   | ProviderOwner, ProviderManager, ProviderStaff | PATCH /providers/:id/products/:productId with price or is_active                       | 200; product_id, updated_at                                                                | —                                           |
| Add provider location (success)            | Add provider location   | Provider   | ProviderOwner, ProviderManager                | POST /providers/:id/locations with address fields                                      | 201; location_id; location.owner_type=provider                                             | —                                           |
| Get provider locations (success)           | Get provider locations  | Provider   | ProviderOwner, ProviderManager, ProviderStaff | GET /providers/:id/locations                                                           | 200; items[] with location_id, address_line_1, city, postal_code                           | —                                           |

---

## 5. Discovery (buyer)

| Scenario                                    | Capability                          | Service(s)       | Role(s)                                       | Steps                                                           | Expected Outcome                                                                                | Event(s) |
| ------------------------------------------- | ----------------------------------- | ---------------- | --------------------------------------------- | --------------------------------------------------------------- | ----------------------------------------------------------------------------------------------- | -------- |
| Search providers (success)                  | Search providers (discovery)        | Search/Discovery | BusinessOwner, BusinessManager, BusinessStaff | GET /discovery/providers with postcode or category; buyer token | 200; items[] with provider_id, trading_name, provider_type; optional rating, distance_km        | —        |
| Search providers unauthenticated (failure)  | Search providers (discovery)        | Search/Discovery | —                                             | GET /discovery/providers without token (if required)            | 401 or 200 per policy                                                                           | —        |
| Get provider public profile (success)       | Get provider public profile         | Search/Discovery | BusinessOwner, BusinessManager, BusinessStaff | GET /discovery/providers/:id with buyer token                   | 200; provider_id, trading_name, provider_type, description?, min_order_value?, lead_time_hours? | —        |
| Get provider catalog for ordering (success) | Get provider catalog (for ordering) | Search/Discovery | BusinessOwner, BusinessManager, BusinessStaff | GET /discovery/providers/:id/products with buyer token          | 200; items[] with product_id, name, sku, category, unit, price, currency                        | —        |

---

## 6. Order flow

| Scenario                                               | Capability                 | Service(s) | Role(s)                                       | Steps                                                                                                                                            | Expected Outcome                                                                                                                    | Event(s)                |
| ------------------------------------------------------ | -------------------------- | ---------- | --------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------- | ----------------------- |
| Place order (success)                                  | Place order                | Order      | BusinessOwner, BusinessManager, BusinessStaff | POST /buyer/orders with provider_id, delivery_location_id, requested_delivery_date, lines[] (product_id, quantity); Idempotency-Key; buyer token | 201; order_id, order_number, status=submitted, total, currency; order_lines created; delivery_location_id belongs to business       | OrderPlaced (async)     |
| Place order idempotent replay (success)                | Place order                | Order      | BusinessOwner, BusinessManager, BusinessStaff | Same POST /buyer/orders with same Idempotency-Key again                                                                                          | 200 or 201; same order_id; no duplicate order                                                                                       | —                       |
| Place order without idempotency key (accept or reject) | Place order                | Order      | BusinessOwner, BusinessManager, BusinessStaff | POST /buyer/orders without Idempotency-Key (twice with same payload)                                                                             | Per policy: 201 twice (two orders) or 400 if key required                                                                           | —                       |
| Place order invalid delivery_location (failure)        | Place order                | Order      | BusinessOwner, BusinessManager, BusinessStaff | POST /buyer/orders with delivery_location_id not belonging to business                                                                           | 400 or 404; order not created                                                                                                       | —                       |
| Place order provider not found (failure)               | Place order                | Order      | BusinessOwner, BusinessManager, BusinessStaff | POST /buyer/orders with non-existent provider_id                                                                                                 | 400 or 404                                                                                                                          | —                       |
| Get my orders buyer (success)                          | Get my orders (buyer)      | Order      | BusinessOwner, BusinessManager, BusinessStaff | GET /buyer/orders with buyer token                                                                                                               | 200; items[] scoped to business; only that business’s orders                                                                        | —                       |
| Get order by id buyer (success)                        | Get order by id (buyer)    | Order      | BusinessOwner, BusinessManager, BusinessStaff | GET /buyer/orders/:id with buyer token; order belongs to business                                                                                | 200; order_id, order_number, provider_id, status, lines[], total, requested_delivery_date                                           | —                       |
| Get order by id buyer wrong business (failure)         | Get order by id (buyer)    | Order      | —                                             | GET /buyer/orders/:id with buyer token for different business                                                                                    | 403 or 404                                                                                                                          | —                       |
| Confirm order (success)                                | Confirm order              | Order      | ProviderOwner, ProviderManager, ProviderStaff | POST /provider/orders/:id/confirm with provider token; order status=submitted                                                                    | 200; order status=confirmed, confirmed_at set; delivery record created (Logistics consumes OrderConfirmed or Order calls Logistics) | OrderConfirmed (async)  |
| Confirm order wrong provider (failure)                 | Confirm order              | Order      | —                                             | POST /provider/orders/:id/confirm with token of different provider                                                                               | 403 or 404                                                                                                                          | —                       |
| Reject order (success)                                 | Reject order               | Order      | ProviderOwner, ProviderManager, ProviderStaff | POST /provider/orders/:id/reject with reason; order status=submitted                                                                             | 200; order status=cancelled                                                                                                         | —                       |
| Update order status to preparing (success)             | Update order status        | Order      | ProviderOwner, ProviderManager, ProviderStaff | PATCH /provider/orders/:id with status=preparing; order status=confirmed                                                                         | 200; order status=preparing                                                                                                         | OrderPrepared (async)   |
| Update order status to shipped (success)               | Update order status        | Order      | ProviderOwner, ProviderManager, ProviderStaff | PATCH /provider/orders/:id with status=shipped; order status=preparing                                                                           | 200; order status=shipped                                                                                                           | OrderDispatched (async) |
| Cancel order by buyer (success)                        | Cancel order (buyer)       | Order      | BusinessOwner, BusinessManager, BusinessStaff | POST /buyer/orders/:id/cancel; order status=submitted or confirmed                                                                               | 200; order status=cancelled                                                                                                         | —                       |
| Cancel order by buyer already shipped (failure)        | Cancel order (buyer)       | Order      | BusinessOwner, BusinessManager, BusinessStaff | POST /buyer/orders/:id/cancel; order status=shipped                                                                                              | 400 or 409; order not cancelled                                                                                                     | —                       |
| Get my orders provider (success)                       | Get my orders (provider)   | Order      | ProviderOwner, ProviderManager, ProviderStaff | GET /provider/orders with provider token                                                                                                         | 200; items[] scoped to provider only                                                                                                | —                       |
| Get order by id provider (success)                     | Get order by id (provider) | Order      | ProviderOwner, ProviderManager, ProviderStaff | GET /provider/orders/:id with provider token; order belongs to provider                                                                          | 200; order_id, business_id, status, lines[], internal_notes                                                                         | —                       |

---

## 7. Delivery

| Scenario                                       | Capability                         | Service(s)        | Role(s)                                       | Steps                                                                                                       | Expected Outcome                                                                             | Event(s)                       |
| ---------------------------------------------- | ---------------------------------- | ----------------- | --------------------------------------------- | ----------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------- | ------------------------------ |
| Create delivery on confirm (system)            | Create delivery (on order confirm) | Order → Logistics | System                                        | After POST /provider/orders/:id/confirm, verify delivery record exists for order_id                         | Delivery row with order_id, status=scheduled (or as designed); 1:1 with order                | — (consumer of OrderConfirmed) |
| Update delivery status to in_transit (success) | Update delivery status             | Logistics         | ProviderOwner, ProviderManager, ProviderStaff | PATCH /deliveries/:id with status=in_transit, optional tracking_code; delivery exists for order of provider | 200; delivery status=in_transit                                                              | —                              |
| Update delivery status to delivered (success)  | Update delivery status             | Logistics         | ProviderOwner, ProviderManager, ProviderStaff | PATCH /deliveries/:id with status=delivered, actual_delivery_at                                             | 200; delivery status=delivered; Order Service may sync order status to delivered             | OrderDelivered (async)         |
| Get delivery tracking buyer (success)          | Get delivery (tracking)            | Logistics         | BusinessOwner, BusinessManager, BusinessStaff | GET /deliveries/:id with buyer token; delivery belongs to order of their business                           | 200; delivery_id, order_id, status, tracking_code, estimated_delivery_at, actual_delivery_at | —                              |
| Get delivery tracking provider (success)       | Get delivery (tracking)            | Logistics         | ProviderOwner, ProviderManager, ProviderStaff | GET /deliveries/:id with provider token; delivery for their order                                           | 200; same payload                                                                            | —                              |
| Update delivery wrong provider (failure)       | Update delivery status             | Logistics         | —                                             | PATCH /deliveries/:id with token of provider not owning the order                                           | 403 or 404                                                                                   | —                              |

---

## 8. Invoice and payment

| Scenario                                     | Capability                     | Service(s) | Role(s)                                                                                      | Steps                                                                                                        | Expected Outcome                                                                                               | Event(s)                                                         |
| -------------------------------------------- | ------------------------------ | ---------- | -------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- |
| Create and issue invoice (success)           | Create and issue invoice       | Payment    | ProviderOwner, ProviderManager, ProviderStaff                                                | POST /invoices with order_id; order status=delivered (or per policy); provider token                         | 201; invoice_id, invoice_number, order_id, total, status=issued, due_date, issued_at; invoice_lines from order | InvoiceGenerated (async)                                         |
| Create invoice for non-owned order (failure) | Create and issue invoice       | Payment    | —                                                                                            | POST /invoices with order_id belonging to another provider                                                   | 403 or 404                                                                                                     | —                                                                |
| List invoices buyer (success)                | List invoices (buyer)          | Payment    | BusinessOwner, BusinessManager, BusinessStaff                                                | GET /buyer/invoices with buyer token                                                                         | 200; items[] only for that business; provider_id, total, status, due_date                                      | —                                                                |
| List invoices provider (success)             | List invoices (provider)       | Payment    | ProviderOwner, ProviderManager, ProviderStaff                                                | GET /provider/invoices with provider token                                                                   | 200; items[] only for that provider; business_id, total, status                                                | —                                                                |
| Get invoice by id (success)                  | Get invoice by id              | Payment    | BusinessOwner, BusinessManager, BusinessStaff; ProviderOwner, ProviderManager, ProviderStaff | GET /invoices/:id with token of buyer or provider party to invoice                                           | 200; invoice_id, provider_id, business_id, order_id, lines[], total, status                                    | —                                                                |
| Get invoice wrong party (failure)            | Get invoice by id              | Payment    | —                                                                                            | GET /invoices/:id with token of user with no link to business_id or provider_id of invoice                   | 403 or 404                                                                                                     | —                                                                |
| Pay invoice initiate (success)               | Pay invoice (initiate payment) | Payment    | BusinessOwner, BusinessManager, BusinessStaff                                                | POST /invoices/:id/payments with return_url, cancel_url; Idempotency-Key; buyer token; invoice status=issued | 200; payment_id, checkout_url (redirect to gateway)                                                            | PaymentInitiated; PaymentCompleted when webhook received (async) |
| Pay invoice idempotent replay (success)      | Pay invoice (initiate payment) | Payment    | BusinessOwner, BusinessManager, BusinessStaff                                                | Same POST with same Idempotency-Key                                                                          | 200; same payment_id; no duplicate charge                                                                      | —                                                                |
| Get payments list (success)                  | Get payments (list)            | Payment    | BusinessOwner, BusinessManager, BusinessStaff; ProviderOwner, ProviderManager, ProviderStaff | GET /payments with buyer or provider token                                                                   | 200; items[] scoped to that business (buyer) or visible to provider (invoices they issued)                     | —                                                                |

---

## 9. Ratings

| Scenario                               | Capability                      | Service(s) | Role(s)                                       | Steps                                                                                                                        | Expected Outcome                                                                         | Event(s)                |
| -------------------------------------- | ------------------------------- | ---------- | --------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------- | ----------------------- |
| Submit rating (success)                | Submit rating (data collection) | Trust      | BusinessOwner, BusinessManager, BusinessStaff | POST /orders/:id/ratings with rating (1–5), optional comment; order status=delivered; order belongs to business; buyer token | 201; rating_id, order_id, provider_id, rating, created_at; one rating per order enforced | RatingSubmitted (async) |
| Submit rating wrong business (failure) | Submit rating                   | Trust      | —                                             | POST /orders/:id/ratings with token of buyer whose business does not own order                                               | 403 or 404                                                                               | —                       |
| Submit rating duplicate (failure)      | Submit rating                   | Trust      | BusinessOwner, BusinessManager, BusinessStaff | POST /orders/:id/ratings for order already rated by this business                                                            | 409 or 422; one rating per order                                                         | —                       |
| Submit rating out of range (failure)   | Submit rating                   | Trust      | BusinessOwner, BusinessManager, BusinessStaff | POST /orders/:id/ratings with rating=0 or rating=6                                                                           | 400; validation error                                                                    | —                       |

---

## 10. Admin

| Scenario                                   | Capability                                | Service(s) | Role(s)                        | Steps                                                                                                   | Expected Outcome                                                               | Event(s)                 |
| ------------------------------------------ | ----------------------------------------- | ---------- | ------------------------------ | ------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------ | ------------------------ |
| List users (success)                       | List users                                | Admin      | PlatformAdmin, PlatformOps     | GET /admin/users with platform admin/ops token                                                          | 200; items[] with user_id, email, first_name, last_name, status                | —                        |
| List users non-admin (failure)             | List users                                | Admin      | —                              | GET /admin/users with buyer or provider token                                                           | 403                                                                            | —                        |
| List businesses (success)                  | List businesses                           | Admin      | PlatformAdmin, PlatformOps     | GET /admin/businesses with platform token                                                               | 200; items[] with business_id, legal_name, trading_name, business_type, status | —                        |
| List providers (success)                   | List providers                            | Admin      | PlatformAdmin, PlatformOps     | GET /admin/providers with platform token                                                                | 200; items[] with provider_id, legal_name, trading_name, provider_type, status | —                        |
| Update user status (success)               | Update user status (active/suspended)     | Identity   | PlatformAdmin, PlatformOps     | PATCH /admin/users/:id with status=suspended                                                            | 200; user_id, status, updated_at; user.status updated                          | —                        |
| Update business status (success)           | Update business status (active/suspended) | Business   | PlatformAdmin, PlatformOps     | PATCH /admin/businesses/:id with status=suspended                                                       | 200; business_id, status, updated_at                                           | —                        |
| Update provider status to active (success) | Update provider status (active/suspended) | Provider   | PlatformAdmin, PlatformOps     | PATCH /admin/providers/:id with status=active; provider was pending_verification                        | 200; provider_id, status=active, updated_at                                    | ProviderVerified (async) |
| Execute payout (success)                   | Execute payout (manual)                   | Payment    | PlatformAdmin, PlatformFinance | POST /admin/payouts with provider_id, optional amount/currency; Idempotency-Key; platform finance token | 200 or 201; payout_id, provider_id, amount, currency, status, executed_at      | PayoutExecuted (async)   |
| Execute payout wrong role (failure)        | Execute payout                            | Payment    | PlatformOps                    | POST /admin/payouts with PlatformOps token (no finance)                                                 | 403                                                                            | —                        |

---

## 11. Permissions and error paths

| Scenario                                     | Capability               | Service(s)                 | Role(s)       | Steps                                                                                     | Expected Outcome                 | Event(s) |
| -------------------------------------------- | ------------------------ | -------------------------- | ------------- | ----------------------------------------------------------------------------------------- | -------------------------------- | -------- |
| Buyer cannot access provider endpoints       | —                        | Provider, Order (provider) | BusinessOwner | GET /provider/orders or GET /providers/:id with buyer token                               | 403; no provider membership      | —        |
| Provider cannot access buyer endpoints       | —                        | Business, Order (buyer)    | ProviderOwner | GET /buyer/orders or POST /buyer/orders with provider token                               | 403; no business membership      | —        |
| Staff cannot update business profile         | Update business profile  | Business                   | BusinessStaff | PATCH /businesses/:id with BusinessStaff token                                            | 403                              | —        |
| Unauthenticated access to protected endpoint | —                        | Any                        | —             | GET /businesses/:id or GET /buyer/orders without Authorization                            | 401                              | —        |
| Invalid or expired token                     | —                        | Identity                   | —             | GET /auth/me or any protected endpoint with invalid/expired Bearer token                  | 401                              | —        |
| Invalid UUID or resource not found           | —                        | Any                        | —             | GET /businesses/:nonExistentId or GET /orders/:wrongId with valid token and correct scope | 404; no data leak                | —        |
| Validation error on place order              | Place order              | Order                      | BusinessOwner | POST /buyer/orders with empty lines[] or negative quantity                                | 400; validation message          | —        |
| Validation error on create invoice           | Create and issue invoice | Payment                    | ProviderOwner | POST /invoices with order_id already invoiced                                             | 400 or 409; no duplicate invoice | —        |

---

## 12. End-to-end flow (success path)

Single scenario that chains capabilities across services to verify integration.

| Scenario                                                                                 | Capability | Service(s)                                                             | Role(s)                              | Steps                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Expected Outcome                                                                                                                                                                                                   | Event(s)                                                                                         |
| ---------------------------------------------------------------------------------------- | ---------- | ---------------------------------------------------------------------- | ------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------ |
| E2E: Register → Business → Discovery → Order → Confirm → Delivery → Invoice → Pay → Rate | Multiple   | Identity, Business, Search/Discovery, Order, Logistics, Payment, Trust | User → BusinessOwner → ProviderOwner | 1) POST /auth/register (buyer). 2) POST /auth/login. 3) POST /businesses + POST /businesses/:id/locations. 4) Register provider user, POST /providers, POST /providers/:id/products. 5) GET /discovery/providers (buyer token). 6) POST /buyer/orders (buyer token, Idempotency-Key). 7) POST /provider/orders/:id/confirm (provider token). 8) PATCH /deliveries/:id status=delivered. 9) POST /invoices (provider), POST /invoices/:id/payments (buyer). 10) Simulate PaymentCompleted webhook. 11) POST /orders/:id/ratings (buyer). | All steps 2xx; order moves submitted→confirmed→delivered; invoice issued and paid; rating stored; events OrderPlaced, OrderConfirmed, OrderDelivered, InvoiceGenerated, PaymentCompleted, RatingSubmitted observed | OrderPlaced, OrderConfirmed, OrderDelivered, InvoiceGenerated, PaymentCompleted, RatingSubmitted |

---

## 13. Service and event summary (per scenario type)

| Flow                 | Service(s)                                   | Sync / Async                                                                                                  | Events produced                                             | Failure handling (test focus)                                                       |
| -------------------- | -------------------------------------------- | ------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------- | ----------------------------------------------------------------------------------- |
| Auth                 | Identity                                     | Sync (login, me, refresh); async (register → email)                                                           | UserRegistered                                              | 401 on bad credentials; 409 on duplicate email                                      |
| Business onboarding  | Business                                     | Sync                                                                                                          | BusinessCreated                                             | 403 on wrong scope; 400 on invalid payload                                          |
| Provider and catalog | Provider                                     | Sync; ProductCreated async                                                                                    | ProviderVerified, ProductCreated                            | 403 wrong provider scope                                                            |
| Discovery            | Search/Discovery                             | Sync read                                                                                                     | —                                                           | 401 if auth required                                                                |
| Order                | Order                                        | Sync (place, confirm, reject, cancel, status); OrderPlaced/OrderConfirmed/OrderPrepared/OrderDispatched async | OrderPlaced, OrderConfirmed, OrderPrepared, OrderDispatched | Idempotency; 400 invalid delivery_location or provider; 403 wrong business/provider |
| Delivery             | Logistics                                    | Sync (PATCH); OrderConfirmed consumed async → create delivery; OrderDelivered emitted on status=delivered     | OrderDelivered                                              | 403 wrong provider                                                                  |
| Invoice and payment  | Payment                                      | Sync (create invoice, initiate pay); InvoiceGenerated async; PaymentCompleted on webhook                      | InvoiceGenerated, PaymentInitiated, PaymentCompleted        | 409 duplicate invoice; Idempotency on payment                                       |
| Rating               | Trust                                        | Sync; RatingSubmitted async                                                                                   | RatingSubmitted                                             | 409 duplicate rating; 400 rating out of 1–5                                         |
| Admin                | Admin, Identity, Business, Provider, Payment | Sync                                                                                                          | ProviderVerified (when set active), PayoutExecuted          | 403 non-platform role; 403 PlatformOps on payout (PlatformFinance only)             |

---

## 14. Preconditions reference

Use these in test setup where needed.

| Entity         | Minimal precondition for tests                                                                                             |
| -------------- | -------------------------------------------------------------------------------------------------------------------------- |
| Buyer user     | User with email/password; one business_users row (business_owner) for one business.                                        |
| Provider user  | User with email/password; one provider_users row (provider_owner) for one provider.                                        |
| Business       | One business record; at least one location (delivery_address) with owner_type=business.                                    |
| Provider       | One provider record (status active for discovery/order); at least one product; optional location.                          |
| Order          | Business, provider, delivery_location_id (business’s location); order in desired status (submitted, confirmed, delivered). |
| Delivery       | Order confirmed; one delivery row with order_id.                                                                           |
| Invoice        | Order delivered (or per policy); no existing invoice for that order.                                                       |
| Payment        | Invoice issued; PaymentCompleted only after gateway webhook (mock in tests).                                               |
| Rating         | Order delivered; no existing rating for that order_id.                                                                     |
| Platform admin | User with platform role (platform_admin or platform_ops or platform_finance) in platform_users or equivalent.              |

---

## 15. Implementation notes for automation

- **Token fixture:** For each role (buyer_owner, provider_owner, admin, ops, finance), create a user and membership, login once, store access_token (and refresh_token if testing refresh).
- **Data cleanup:** Use transactional rollback or dedicated test DB; avoid shared state between tests that mutate data.
- **Event assertion:** Subscribe to event bus or use in-memory event log in test env; after mutation, assert expected event_type and minimal payload (e.g. order_id, business_id).
- **Idempotency:** For POST /buyer/orders and POST /invoices/:id/payments, run the same request twice with same Idempotency-Key; assert same resource id and no duplicate side effects.
- **403 vs 404:** For scope violations return 403; for missing resource in allowed scope return 404. Tests should assert the expected code per permission model.
